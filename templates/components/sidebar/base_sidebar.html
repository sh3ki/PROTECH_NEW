<div class="sidebar-wrapper h-full flex flex-col" style="background: linear-gradient(180deg, #023c82 0%, #02306e 100%);">
    <script>
    // Apply collapsed state before ANY rendering happens
    if (localStorage.getItem('sidebarCollapsed') === 'true') {
        document.getElementById('sidebar').classList.add('collapsed');
    }
    </script>
    <!-- Sidebar header with logo -->
    <div class="sidebar-header flex items-center justify-between p-4 border-b border-blue-800">
        <div class="flex items-center space-x-2 sidebar-logo">
            {% load static %}
            <img src="{% static 'public/images/protechlogo.svg' %}" class="h-10 w-10 text-white" alt="ProTech Logo">
            <span class="sidebar-text inline-block font-extrabold italic tracking-tight leading-tight text-xs text-white ml-1" style="font-family: 'Arial Black', Arial, sans-serif;">
                DETECT<br>TO PROTECT
            </span>
        </div>
    </div>
    
    <!-- User info section -->
    <div class="p-4 border-b border-blue-800 user-info-section">
        <div class="flex items-center">
            <div class="w-10 h-10 rounded-full bg-tertiary/30 flex items-center justify-center flex-shrink-0 overflow-hidden">
                {% if user.profile_pic %}
                    <img src="{% url 'serve_profile_pic' path=user.profile_pic %}" alt="{{ user.get_full_name }}" class="w-full h-full rounded-full object-cover">
                {% else %}
                    <span class="text-white font-bold text-sm">
                        {% if user.first_name %}
                            {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                        {% else %}
                            {{ user.username|first|upper }}
                        {% endif %}
                    </span>
                {% endif %}
            </div>
            <div class="ml-3 sidebar-text overflow-hidden">
                <p class="text-sm font-medium text-white whitespace-nowrap overflow-hidden text-ellipsis">
                    {% if user.first_name %}
                        {{ user.first_name }} {{ user.last_name }}
                    {% else %}
                        {{ user.username }}
                    {% endif %}
                </p>
                <p class="text-xs text-blue-200 whitespace-nowrap overflow-hidden text-ellipsis">{{ user.get_role_display }}</p>
            </div>
        </div>
    </div>
    
    <!-- Navigation Menu -->
    <div class="sidebar-menu py-4 flex-grow overflow-y-auto px-2" style="scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent;">
        {% block sidebar_menu %}
        <!-- This block will be overridden by specific sidebar menu items -->
        {% endblock %}
    </div>
    
    <!-- Logout button - always at the bottom -->
    <div class="px-2 py-3 pt-2 mt-auto">
        <button type="button" id="logout-btn" class="menu-item hover:bg-red-700 w-full" title="Logout">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            <span class="sidebar-text">Logout</span>
        </button>
    </div>
</div>

<style>
    /* Base menu item styles */
    .menu-item {
        @apply flex items-center px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-secondary/10 dark:hover:bg-tertiary/20 rounded-md;
    }
    
    .menu-item.active {
        @apply bg-secondary/20 dark:bg-tertiary/30 text-primary dark:text-tertiary font-medium;
    }
    
    .menu-item svg:first-child {
        @apply mr-3 text-gray-500 dark:text-gray-400;
    }
    
    /* Submenu styles */
    .submenu {
        @apply max-h-0 overflow-hidden pl-7;
    }
    
    .submenu.open {
        @apply max-h-screen;
    }
    
    .submenu-item {
        @apply flex items-center px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-secondary/10 dark:hover:bg-tertiary/20 rounded-md;
    }
    
    .submenu-item.active {
        @apply bg-secondary/10 dark:bg-tertiary/20 text-primary dark:text-tertiary;
    }
    
    /* Sidebar collapse styles - ONLY on desktop (lg and up) */
    @media (min-width: 1024px) {
        #sidebar.collapsed {
            width: 4.5rem !important;
        }
        
        #sidebar.collapsed .sidebar-text {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            width: 0 !important;
            overflow: hidden !important;
        }
        
        #sidebar.collapsed .menu-item {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
            height: 2.75rem;
        }
        
        #sidebar.collapsed .menu-item svg:first-child {
            margin-right: 0;
        }
        
        #sidebar.collapsed .user-info-section .ml-3 {
            display: none !important;
            visibility: hidden !important;
        }
        
        #sidebar.collapsed .sidebar-header {
            justify-content: center;
        }
        
        #sidebar.collapsed .sidebar-logo span {
            display: none !important;
            visibility: hidden !important;
        }
        
        #sidebar.collapsed .sidebar-logo {
            justify-content: center;
            width: 100%;
        }
        
        #sidebar.collapsed #sidebar-collapse-btn {
            transform: rotate(180deg);
        }
        
        /* Position button based on sidebar state */
        #sidebar.collapsed ~ #sidebar-collapse-btn {
            left: 3.5rem;
        }
    }
    
    #sidebar {
        position: relative;
    }
    
    .sidebar-text {
        white-space: nowrap;
    }
    
    /* Only apply transitions when user is actively toggling */
    body.sidebar-toggling #sidebar {
        transition: width 0.3s ease-in-out;
    }
    
    body.sidebar-toggling .sidebar-text {
        transition: opacity 0.15s ease-in-out;
    }
    
    body.sidebar-toggling #sidebar-collapse-btn {
        transition: transform 0.3s ease-in-out;
    }
    
    /* Fixed height for menu items to prevent reflow */
    .menu-item {
        min-height: 2.75rem;
        height: 2.75rem;
        display: flex;
        align-items: center;
    }
    
    .menu-item svg:first-child {
        flex-shrink: 0;
        width: 1.25rem;
        height: 1.25rem;
    }
    
    /* Keep logo size consistent */
    .sidebar-logo img {
        width: 2.5rem;
        height: 2.5rem;
        flex-shrink: 0;
    }
    
    /* User avatar consistent size */
    .user-info-section .w-10 {
        width: 2.5rem;
        height: 2.5rem;
        flex-shrink: 0;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Logout confirmation modal
    const logoutBtn = document.getElementById('logout-btn');
    const logoutModal = document.getElementById('logout-modal');
    const cancelLogoutBtn = document.getElementById('cancel-logout-btn');
    
    if (logoutBtn && logoutModal) {
        logoutBtn.addEventListener('click', function() {
            logoutModal.classList.remove('hidden');
            logoutModal.classList.add('flex');
            setTimeout(() => {
                logoutModal.classList.remove('opacity-0');
                logoutModal.classList.add('opacity-100');
                const modalContent = logoutModal.querySelector('div > div');
                if (modalContent) {
                    modalContent.classList.remove('scale-95');
                    modalContent.classList.add('scale-100');
                }
            }, 10);
        });
        
        if (cancelLogoutBtn) {
            cancelLogoutBtn.addEventListener('click', function() {
                logoutModal.classList.add('opacity-0');
                logoutModal.classList.remove('opacity-100');
                const modalContent = logoutModal.querySelector('div > div');
                if (modalContent) {
                    modalContent.classList.add('scale-95');
                    modalContent.classList.remove('scale-100');
                }
                setTimeout(() => {
                    logoutModal.classList.add('hidden');
                    logoutModal.classList.remove('flex');
                }, 300);
            });
        }
        
        // Close modal on backdrop click
        logoutModal.addEventListener('click', function(e) {
            if (e.target === logoutModal) {
                cancelLogoutBtn.click();
            }
        });
    }
    
    // Universal sidebar toggle button (works for both mobile and desktop)
    const sidebarCollapseBtn = document.getElementById('sidebar-collapse-btn');
    const sidebar = document.getElementById('sidebar');
    
    if (sidebarCollapseBtn && sidebar) {
        sidebarCollapseBtn.addEventListener('click', function() {
            const isMobile = window.innerWidth < 1024; // lg breakpoint
            
            if (isMobile) {
                // Mobile: toggle sidebar slide in/out
                const isOpen = sidebar.classList.contains('translate-x-0');
                if (isOpen) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            } else {
                // Desktop: toggle collapse/expand
                const chevronIcon = document.getElementById('chevron-icon');
                const isCollapsed = sidebar.classList.contains('collapsed');
                
                // Only add animation class when user manually clicks the button
                document.body.classList.add('sidebar-toggling');
                
                // Enable button transition with same timing as sidebar
                sidebarCollapseBtn.style.transition = 'left 0.3s ease-in-out';
                
                sidebar.classList.toggle('collapsed');
                
                // Update button position and icon simultaneously
                if (isCollapsed) {
                    // Expanding
                    sidebarCollapseBtn.style.left = '240px';
                    if (chevronIcon) {
                        chevronIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />';
                    }
                } else {
                    // Collapsing
                    sidebarCollapseBtn.style.left = '56px';
                    if (chevronIcon) {
                        chevronIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M6 5l7 7-7 7" />';
                    }
                }
                
                // Save state to localStorage
                const newCollapsedState = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', newCollapsedState);
                
                // Remove animation class and button transition after transition completes
                setTimeout(() => {
                    document.body.classList.remove('sidebar-toggling');
                    sidebarCollapseBtn.style.transition = '';
                }, 300);
            }
        });
    }
    
    // Handle window resize to adjust button position
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            const btn = document.getElementById('sidebar-collapse-btn');
            const icon = document.getElementById('chevron-icon');
            const sidebar = document.getElementById('sidebar');
            const isMobile = window.innerWidth < 1024;
            
            if (btn && sidebar) {
                if (isMobile) {
                    // Mobile: reset to appropriate mobile state
                    const isOpen = sidebar.classList.contains('translate-x-0');
                    if (isOpen) {
                        btn.style.left = '246px';
                        if (icon) {
                            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />';
                        }
                    } else {
                        btn.style.left = '-7px';
                        if (icon) {
                            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M6 5l7 7-7 7" />';
                        }
                    }
                } else {
                    // Desktop: ensure sidebar is visible and button positioned correctly
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                    const backdrop = document.getElementById('sidebar-backdrop');
                    if (backdrop) {
                        backdrop.classList.add('hidden');
                    }
                    
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    if (isCollapsed) {
                        btn.style.left = '56px';
                        if (icon) {
                            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M6 5l7 7-7 7" />';
                        }
                    } else {
                        btn.style.left = '240px';
                        if (icon) {
                            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />';
                        }
                    }
                }
            }
        }, 100);
    });
    
    // Setup collapsible menus
    const collapsibleMenus = document.querySelectorAll('.collapsible-menu');
    collapsibleMenus.forEach(menu => {
        const button = menu.querySelector('.menu-item');
        const submenu = menu.querySelector('.submenu');
        const chevron = menu.querySelector('.menu-chevron');
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Toggle submenu
            submenu.classList.toggle('open');
            
            // Rotate chevron
            chevron.classList.toggle('rotate');
        });
    });
    
    // Exclude certain links from AJAX navigation (like logout)
    document.querySelectorAll('a[data-ajax-navigation="false"]').forEach(link => {
        link.setAttribute('data-ajax-bypass', 'true');
    });
});
</script>
