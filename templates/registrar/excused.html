{% extends 'components/base_component.html' %}
{% load static %}
{% get_media_prefix as MEDIA_URL %}

{% block title %}PROTECH - Excused Absences Management{% endblock %}
{% block page_title %}Excused Absences Management{% endblock %}

{% block sidebar %}
    {% include 'components/sidebar/registrar_sidebar.html' with active='excused' %}
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Toast Container -->
<div id="excused-toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3"></div>


<!-- Dashboard Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border-l-4 border-blue-500 dark:border-blue-400 transition-all hover:shadow-md">
        <div class="flex items-center">
            <div class="rounded-full bg-blue-100 dark:bg-blue-900/30 p-3 mr-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 dark:text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <div>
                <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Excused</p>
                <h3 class="font-bold text-2xl text-gray-900 dark:text-white">{{ total_excused }}</h3>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border-l-4 border-green-500 dark:border-green-400 transition-all hover:shadow-md">
        <div class="flex items-center">
            <div class="rounded-full bg-green-100 dark:bg-green-900/30 p-3 mr-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 dark:text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div>
                <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Active Excused</p>
                <h3 class="font-bold text-2xl text-gray-900 dark:text-white">{{ active_excused }}</h3>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border-l-4 border-yellow-500 dark:border-yellow-400 transition-all hover:shadow-md">
        <div class="flex items-center">
            <div class="rounded-full bg-yellow-100 dark:bg-yellow-900/30 p-3 mr-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600 dark:text-yellow-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div>
                <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Upcoming Excused</p>
                <h3 class="font-bold text-2xl text-gray-900 dark:text-white" id="upcoming-excused-count">{{ upcoming_excused }}</h3>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border-l-4 border-red-500 dark:border-red-400 transition-all hover:shadow-md">
        <div class="flex items-center">
            <div class="rounded-full bg-red-100 dark:bg-red-900/30 p-3 mr-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 dark:text-red-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
            </div>
            <div>
                <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Expired Excused</p>
                <h3 class="font-bold text-2xl text-gray-900 dark:text-white">{{ expired_excused }}</h3>
            </div>
        </div>
    </div>
</div>

<div class="mb-6">
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center space-y-4 lg:space-y-0">
        <!-- Search and Filter Controls -->
        <div class="flex flex-col md:flex-row gap-4 w-full lg:w-3/4 xl:w-2/3">
            <div class="relative flex-grow">
                <input type="text" id="excused-search" placeholder="Search by name, LRN, or section..." 
                    class="pl-12 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary/50 dark:focus:ring-tertiary/50 focus:border-primary dark:focus:border-tertiary transition-colors dark:bg-gray-700 dark:text-white w-full shadow-sm text-md">
                <div class="absolute inset-y-0 left-0 flex items-center pl-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <div id="excused-search-spinner" class="hidden absolute inset-y-0 right-0 flex items-center pr-4">
                    <svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <div id="excused-search-results-count" class="hidden absolute inset-y-0 right-0 flex items-center pr-4 text-sm text-gray-500 dark:text-gray-400">
                    <span></span>
                </div>
            </div>
            <div class="flex flex-wrap md:flex-nowrap gap-2">
                <!-- Grade filter -->
                <div class="relative w-full sm:w-auto">
                    <select id="excused-grade-filter" class="appearance-none pl-10 pr-10 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary/50 dark:focus:ring-tertiary/50 focus:border-primary dark:focus:border-tertiary transition-colors dark:bg-gray-700 dark:text-white shadow-sm text-md w-full">
                        <option value="">All Grades</option>
                        {% for grade in grades %}
                            <option value="{{ grade.id }}" {% if grade_filter == grade.id|stringformat:"s" %}selected{% endif %}>{{ grade.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary dark:text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
                <!-- Section filter -->
                <div class="relative w-full sm:w-auto">
                    <select id="excused-section-filter" class="appearance-none pl-10 pr-10 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary/50 dark:focus:ring-tertiary/50 focus:border-primary dark:focus:border-tertiary transition-colors dark:bg-gray-700 dark:text-white shadow-sm text-md w-full">
                        <option value="">Select grade first</option>
                        {% for section in sections %}
                            <option value="{{ section.id }}" data-grade="{{ section.grade.id }}" {% if section_filter == section.id|stringformat:"s" %}selected{% endif %}>{{ section.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary dark:text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v2M7 7h10" />
                        </svg>
                    </div>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
                <!-- Status filter -->
                <div class="relative w-full sm:w-auto">
                    <select id="excused-status-filter" class="appearance-none pl-10 pr-10 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary/50 dark:focus:ring-tertiary/50 focus:border-primary dark:focus:border-tertiary transition-colors dark:bg-gray-700 dark:text-white shadow-sm text-md w-full">
                        <option value="">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="UPCOMING">Upcoming</option>
                        <option value="EXPIRED">Expired</option>
                    </select>
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary dark:text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
                <!-- Date filter -->
                <div class="relative w-full sm:w-auto">
                    <input type="date" id="excused-date-filter" class="pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary/50 dark:focus:ring-tertiary/50 focus:border-primary dark:focus:border-tertiary transition-colors dark:bg-gray-700 dark:text-white shadow-sm text-md w-full" value="{{ date_filter|default:'' }}">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary dark:text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <!-- Action buttons -->
        <div class="flex flex-wrap md:flex-nowrap gap-2">
            <button id="import-excused-btn" class="flex items-center bg-gradient-to-r from-blue-500 to-blue-400 hover:from-blue-600 hover:to-blue-500 text-white px-4 py-2.5 rounded-xl transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                </svg>
                <span class="hidden sm:inline">Import</span>
            </button>
            <!-- Export Dropdown Button -->
            <div class="relative">
                <button id="export-excused-btn" class="flex items-center bg-gradient-to-r from-green-500 to-green-400 hover:from-green-600 hover:to-green-500 text-white px-4 py-2.5 rounded-xl transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <span class="hidden sm:inline">Export</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <!-- Dropdown Menu -->
                <div id="export-excused-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-lg z-50 border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <a href="#" class="export-excused-option flex items-center px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-format="pdf">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        <span class="text-gray-700 dark:text-gray-200 font-medium">Export as PDF</span>
                    </a>
                    <a href="#" class="export-excused-option flex items-center px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-format="excel">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span class="text-gray-700 dark:text-gray-200 font-medium">Export as Excel</span>
                    </a>
                    <a href="#" class="export-excused-option flex items-center px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-format="word">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="text-gray-700 dark:text-gray-200 font-medium">Export as Word</span>
                    </a>
                </div>
            </div>
            <button id="print-excused-btn" class="flex items-center bg-gradient-to-r from-purple-500 to-purple-400 hover:from-purple-600 hover:to-purple-500 text-white px-4 py-2.5 rounded-xl transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                <span class="hidden sm:inline">Print</span>
            </button>
            <button id="add-excused-btn" class="flex items-center bg-gradient-to-r from-secondary to-secondary/80 hover:from-secondary/90 hover:to-secondary/70 text-white px-4 py-2.5 rounded-xl transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span class="hidden sm:inline">Add Excused</span>
            </button>
        </div>
    </div>
</div>

<!-- Excused table container with loading state -->
<div id="excused-table-container" class="relative">
    <div id="excused-table-loading" class="hidden absolute inset-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm z-10 flex items-center justify-center rounded-xl">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-12 w-12 text-primary dark:text-tertiary mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600 dark:text-gray-300 font-medium">Loading excused absences...</p>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-100 dark:border-gray-700 transition-all">
        <div class="overflow-x-auto">
            <table id="excused-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900/50">
                    <tr>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">LRN</th>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Profile</th>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Grade</th>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Section</th>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date Absent</th>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Effective Date</th>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">End Date</th>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Excuse Letter</th>
                        <th class="px-6 py-3.5 text-left font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3.5 text-center font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="excused-table-body">
                    <!-- Table content will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
        {% include 'components/pagination.html' with pagination_id='excused-pagination-container' items_per_page=10 %}
    </div>
    <div id="excused-no-results" class="hidden py-20 text-center bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700">
        <div class="flex flex-col items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 dark:text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="text-xl font-medium text-gray-900 dark:text-white mb-1">No excused absences found</h3>
            <p class="text-gray-500 dark:text-gray-400">Try adjusting your search or filter criteria</p>
        </div>
    </div>
</div>

<!-- Excuse Letter Modal -->
<div id="excuse-letter-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" id="excuse-letter-backdrop" aria-hidden="true"></div>
        <div class="relative bg-white dark:bg-gray-800 rounded-xl max-w-lg w-full mx-auto shadow-xl transform transition-all p-6 flex flex-col items-center">
            <div class="absolute top-4 right-4">
                <button id="close-excuse-letter-modal" class="text-gray-400 hover:text-gray-500 dark:text-gray-500 dark:hover:text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Excuse Letter</h3>
            <img id="excuse-letter-img" src="" alt="Excuse Letter" class="max-w-full max-h-[60vh] rounded shadow border border-gray-200 dark:border-gray-700 mb-2">
            <div id="excuse-letter-filename" class="text-gray-500 dark:text-gray-400 text-xs mt-2"></div>
        </div>
    </div>
</div>

<!-- Add Excused Modal -->
<div id="add-excused-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" id="add-excused-backdrop" aria-hidden="true"></div>
        <div class="relative bg-white dark:bg-gray-800 rounded-xl max-w-2xl w-full mx-auto shadow-xl transform transition-all">
            <!-- Header -->
            <div class="bg-gradient-to-r from-secondary to-secondary/80 px-6 py-4 rounded-t-xl">
                <h3 class="text-xl font-bold text-white">Add Excused Absence</h3>
            </div>
            
            <!-- Body -->
            <form id="add-excused-form" class="p-6">
                {% csrf_token %}
                <div class="space-y-4">
                    <!-- Student Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Grade Level *</label>
                            <select id="add-excused-grade" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white">
                                <option value="">Select Grade</option>
                                {% for grade in grades %}
                                    <option value="{{ grade.id }}">{{ grade.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Section *</label>
                            <select id="add-excused-section" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white">
                                <option value="">Select grade first</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Student *</label>
                        <select id="add-excused-student" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white">
                            <option value="">Select section first</option>
                        </select>
                    </div>

                    <!-- Date Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date Absent *</label>
                            <input type="date" id="add-excused-date-absent" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Effective Date *</label>
                            <input type="date" id="add-excused-effective-date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">End Date *</label>
                            <input type="date" id="add-excused-end-date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>

                    <!-- Reason -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reason *</label>
                        <textarea id="add-excused-reason" required rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white" placeholder="Enter reason for excused absence"></textarea>
                    </div>

                    <!-- Excuse Letter Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Excuse Letter (Optional)</label>
                        <input type="file" id="add-excused-letter" accept="image/*,.pdf" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary dark:bg-gray-700 dark:text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Upload an image or PDF file. Max size: 5MB</p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" id="cancel-add-excused" class="px-6 py-2.5 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">Cancel</button>
                    <button type="submit" id="submit-add-excused" class="px-6 py-2.5 bg-gradient-to-r from-secondary to-secondary/80 hover:from-secondary/90 hover:to-secondary/70 text-white font-medium rounded-lg transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Add Excused
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Excused Modal -->
<div id="edit-excused-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" id="edit-excused-backdrop" aria-hidden="true"></div>
        <div class="relative bg-white dark:bg-gray-800 rounded-xl max-w-2xl w-full mx-auto shadow-xl transform transition-all">
            <!-- Header -->
            <div class="bg-gradient-to-r from-secondary to-secondary/80 px-6 py-4 rounded-t-xl">
                <h3 class="text-xl font-bold text-white">Edit Excused Absence</h3>
            </div>
            
            <!-- Body -->
            <form id="edit-excused-form" class="p-6">
                {% csrf_token %}
                <input type="hidden" id="edit-excused-id">
                <div class="space-y-4">
                    <!-- Student Info (Read Only) -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Student</label>
                                <p id="edit-excused-student-name" class="text-gray-900 dark:text-white font-medium">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">LRN</label>
                                <p id="edit-excused-lrn" class="text-gray-900 dark:text-white font-medium">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Grade & Section</label>
                                <p id="edit-excused-grade-section" class="text-gray-900 dark:text-white font-medium">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Date Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date Absent *</label>
                            <input type="date" id="edit-excused-date-absent" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Effective Date *</label>
                            <input type="date" id="edit-excused-effective-date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">End Date *</label>
                            <input type="date" id="edit-excused-end-date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary focus:border-primary dark:focus:border-tertiary dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>

                    <!-- Current Excuse Letter -->
                    <div id="current-excuse-letter-section" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Excuse Letter</label>
                        <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <i class="fas fa-file-alt text-primary dark:text-tertiary text-xl"></i>
                            <a id="current-excuse-letter-link" href="#" target="_blank" class="text-primary dark:text-tertiary hover:underline font-medium flex-1">View Current Letter</a>
                            <button type="button" id="remove-excuse-letter-btn" class="text-red-600 hover:text-red-700 text-sm font-medium">
                                <i class="fas fa-times mr-1"></i>Remove
                            </button>
                        </div>
                    </div>

                    <!-- New Excuse Letter Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Update Excuse Letter (Optional)</label>
                        <input type="file" id="edit-excused-letter" accept="image/*,.pdf" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-tertiary dark:bg-gray-700 dark:text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Upload a new file to replace the existing one. Max size: 5MB</p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" id="cancel-edit-excused" class="px-6 py-2.5 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">Cancel</button>
                    <button type="submit" id="submit-edit-excused" class="px-6 py-2.5 bg-gradient-to-r from-secondary to-secondary/80 hover:from-secondary/90 hover:to-secondary/70 text-white font-medium rounded-lg transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Excused Modal -->
<div id="import-excused-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm hidden flex items-center justify-center z-[9999] p-4 transition-all duration-300">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-hidden transform transition-all duration-300 scale-95 opacity-0 modal-content">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-primary to-tertiary px-8 py-6 flex items-center justify-between sticky top-0 z-10">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-file-import text-white text-lg"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white">Import Excused Absences</h3>
                    <p class="text-white/80 text-sm">Upload Excel or CSV with required columns</p>
                </div>
            </div>
            <button type="button" id="close-import-excused-modal" class="text-white/80 hover:text-white hover:bg-white/20 rounded-lg p-2 transition-all duration-200">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-8 overflow-y-auto max-h-[calc(95vh-180px)]" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
            <!-- Instructions -->
            <div class="mb-8 p-6 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">File Format Instructions</h4>
                    <a href="/admin/excused/import/template/" class="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm font-medium shadow-sm">
                        <i class="fas fa-file-excel mr-2"></i>
                        Download Template
                    </a>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300">Supported formats: Excel (.xlsx, .xls) and CSV (.csv). Maximum file size: 10MB.</p>
            </div>

            <!-- Template Download Section -->
            <div class="mb-8 p-6 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl border border-green-200 dark:border-green-800">
                <div class="flex items-start gap-4">
                    <div class="w-14 h-14 rounded-lg bg-white/20 flex items-center justify-center">
                        <i class="fas fa-file-excel text-green-600 text-2xl"></i>
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-900 dark:text-white">Excused Absence Import Template</h5>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Excel template with proper format and column headers.</p>
                        <div class="mt-3">
                            <a href="/admin/excused/import/template/" class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-700 text-primary dark:text-tertiary rounded-lg shadow-sm hover:shadow transition-colors text-sm">
                                <i class="fas fa-download mr-2"></i>Download Template
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column Specifications Table -->
            <div class="mb-8">
                <h5 class="font-medium text-gray-900 dark:text-white mb-3">Required Columns and Format</h5>
                <div class="bg-white dark:bg-gray-800 rounded border p-3 font-mono text-sm overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="px-3 py-2 text-xs text-gray-500">Column</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Required</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Format / Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-t">
                                <td class="px-3 py-2">ID</td>
                                <td class="px-3 py-2">Optional</td>
                                <td class="px-3 py-2">Leave blank for new records. If provided and exists, row will be skipped.</td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-3 py-2">Student LRN</td>
                                <td class="px-3 py-2">Required</td>
                                <td class="px-3 py-2">Exactly 12 digits. Student must exist in the system.</td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-3 py-2">Start Date</td>
                                <td class="px-3 py-2">Required</td>
                                <td class="px-3 py-2">Format: YYYY-MM-DD (e.g., 2025-11-23)</td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-3 py-2">End Date</td>
                                <td class="px-3 py-2">Required</td>
                                <td class="px-3 py-2">Format: YYYY-MM-DD. Must be same or after Start Date.</td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-3 py-2">Reason</td>
                                <td class="px-3 py-2">Required</td>
                                <td class="px-3 py-2">Text description of absence reason</td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-3 py-2">Status</td>
                                <td class="px-3 py-2">Required</td>
                                <td class="px-3 py-2">One of: ACTIVE, UPCOMING, or EXPIRED (case-sensitive)</td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-3 py-2">Notes</td>
                                <td class="px-3 py-2">Optional</td>
                                <td class="px-3 py-2">Additional notes or comments</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Important Notes -->
            <div class="mb-8 p-6 bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-500 rounded-lg">
                <h5 class="font-medium text-amber-800 dark:text-amber-200 mb-2">Important Notes</h5>
                <ul class="text-sm text-amber-700 dark:text-amber-300 space-y-2">
                    <li>• Existing Records: If the ID column contains an existing record ID, that row will be automatically skipped to prevent duplicates.</li>
                    <li>• Student Validation: The Student LRN must match an existing student in the system.</li>
                    <li>• Date Logic: End Date must be the same as or after Start Date.</li>
                    <li>• Status Values: Only <strong>ACTIVE</strong>, <strong>UPCOMING</strong>, or <strong>EXPIRED</strong> are accepted (case-sensitive).</li>
                    <li>• Validation: All data is validated before import. If errors are found, the entire import will be cancelled and you'll see detailed error messages.</li>
                </ul>
            </div>

            <!-- File Upload Section -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <i class="fas fa-cloud-upload-alt text-primary mr-2"></i>
                    Upload File
                </h4>
                <form id="import-excused-form" class="space-y-4">
                    {% csrf_token %}
                    <div class="flex items-center justify-center w-full">
                        <label for="import-excused-file" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-xl cursor-pointer bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 transition-all duration-200 group">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 dark:text-gray-500 group-hover:text-primary dark:group-hover:text-tertiary mb-3 transition-colors"></i>
                                <p class="mb-2 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="font-semibold">Click to upload</span> or drag and drop
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Excel (.xlsx, .xls) or CSV files (MAX. 10MB)</p>
                                <p id="import-excused-file-name" class="mt-2 text-sm font-medium text-primary dark:text-tertiary hidden"></p>
                            </div>
                            <input id="import-excused-file" name="file" type="file" class="hidden" accept=".csv,.xlsx,.xls" />
                        </label>
                    </div>

                    <!-- Progress Bar -->
                    <div id="import-excused-progress" class="hidden">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Importing excused absences...</span>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="import-excused-progress-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                            <div id="import-excused-progress-bar" class="bg-gradient-to-r from-primary to-tertiary h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Import Results -->
                    <div id="import-excused-results" class="hidden mt-6"></div>
                </form>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="bg-gray-50 dark:bg-gray-900 px-8 py-6 flex items-center justify-end space-x-3 border-t border-gray-200 dark:border-gray-700 sticky bottom-0">
            <button type="button" id="cancel-import-excused" class="px-6 py-2.5 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200 shadow-sm">Cancel</button>
            <button type="button" id="submit-import-excused" class="px-6 py-2.5 bg-gradient-to-r from-primary to-tertiary text-white font-medium rounded-lg hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"><i class="fas fa-upload mr-2"></i>Import</button>
        </div>
    </div>
</div>

<script src="{% static 'js/pagination-component.js' %}"></script>
<script>
// Define static path for default image ONCE, outside DOMContentLoaded
const DEFAULT_EXCUSE_LETTER_IMG = "{% static 'images/default-excuse-letter.png' %}";

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Pagination Component
    const excusedPagination = new PaginationComponent({
        containerId: 'excused-pagination-container',
        fetchFunction: loadExcusedAbsences,
        itemsPerPage: 10
    });
    
    // Fetch and render excused absences on page load
    loadExcusedAbsences();

    // Add event listeners for filters/search (implement as needed)
    // ...existing code for filters...

    // Import modal open/close handlers (ensure footer stays visible)
    const importExcusedBtn = document.getElementById('import-excused-btn');
    const importExcusedModal = document.getElementById('import-excused-modal');
    const importExcusedContent = importExcusedModal?.querySelector('.modal-content');
    if (importExcusedBtn) {
        importExcusedBtn.addEventListener('click', function() {
            importExcusedModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => {
                if (importExcusedContent) {
                    importExcusedContent.classList.remove('scale-95', 'opacity-0');
                    importExcusedContent.classList.add('scale-100', 'opacity-100');
                }
            }, 10);
            // Reset form and UI
            const form = document.getElementById('import-excused-form');
            if (form) form.reset();
            const fileName = document.getElementById('import-excused-file-name'); if (fileName) fileName.classList.add('hidden');
            const progress = document.getElementById('import-excused-progress'); if (progress) progress.classList.add('hidden');
            const results = document.getElementById('import-excused-results'); if (results) { results.classList.add('hidden'); results.innerHTML = ''; }
            const submitBtn = document.getElementById('submit-import-excused'); if (submitBtn) submitBtn.disabled = true;
        });
    }

    // Close modal when clicking on backdrop (outside modal content)
    if (importExcusedModal) {
        importExcusedModal.addEventListener('click', function(e) {
            if (e.target === importExcusedModal) {
                closeImportExcusedModal();
            }
        });
    }

    function closeImportExcusedModal() {
        if (!importExcusedModal) return;
        if (importExcusedContent) {
            importExcusedContent.classList.remove('scale-100', 'opacity-100');
            importExcusedContent.classList.add('scale-95', 'opacity-0');
        }
        setTimeout(() => {
            importExcusedModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }, 300);
    }

    const closeImportExcusedBtn = document.getElementById('close-import-excused-modal');
    const cancelImportExcusedBtn = document.getElementById('cancel-import-excused');
    if (closeImportExcusedBtn) closeImportExcusedBtn.addEventListener('click', closeImportExcusedModal);
    if (cancelImportExcusedBtn) cancelImportExcusedBtn.addEventListener('click', closeImportExcusedModal);

    function getProfilePicUrl(filename) {
        if (!filename) {
            return "{% url 'serve_profile_pic_default' %}";
        }
        return `/profile-pics/${filename}/`;
    }

    function getExcuseLetterUrl(filename) {
        if (!filename || filename === 'default-excuse-letter.png') {
            // Always use static for the default image
            return DEFAULT_EXCUSE_LETTER_IMG;
        }
        // Remove 'private_excuse_letters/' prefix if it exists in the filename
        let cleanFilename = filename;
        if (filename.startsWith('private_excuse_letters/')) {
            cleanFilename = filename.replace('private_excuse_letters/', '');
        }
        // Serve from private_excuse_letters via Django view (plural)
        return `/private-excuse-letters/${encodeURIComponent(cleanFilename)}/`;
    }

    function showExcuseLetterModal(url, filename) {
        const modal = document.getElementById('excuse-letter-modal');
        const img = document.getElementById('excuse-letter-img');
        const fname = document.getElementById('excuse-letter-filename');
        
        // Check if this is a default/missing file
        if (url === DEFAULT_EXCUSE_LETTER_IMG || !filename || filename === 'No Excuse Letter') {
            img.src = DEFAULT_EXCUSE_LETTER_IMG;
            fname.textContent = 'No Excuse Letter';
        } else {
            // Try to load the actual file
            img.src = DEFAULT_EXCUSE_LETTER_IMG; // Show default first
            fname.textContent = filename;
            
            // Attempt to verify file exists before showing
            fetch(url, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        img.src = url; // File exists, load it
                    } else {
                        // File doesn't exist, show message
                        fname.textContent = `${filename} (File not found on server)`;
                    }
                })
                .catch(() => {
                    // Network error or file doesn't exist
                    fname.textContent = `${filename} (File not found on server)`;
                });
        }
        
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeExcuseLetterModal() {
        document.getElementById('excuse-letter-modal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    document.getElementById('close-excuse-letter-modal').addEventListener('click', closeExcuseLetterModal);
    document.getElementById('excuse-letter-backdrop').addEventListener('click', closeExcuseLetterModal);

    function showToast(message, type = 'success', duration = 4000) {
        const toastContainer = document.getElementById('excused-toast-container');
        const toast = document.createElement('div');
        toast.className = 'flex items-center w-full max-w-xs p-4 mb-2 rounded-lg shadow-lg transition-all duration-300 transform translate-y-[-1rem] opacity-0';

        let iconHTML = '';
        let bgColor = '';
        switch (type) {
            case 'success':
                bgColor = 'bg-green-100 text-green-700 dark:bg-green-800 dark:text-green-200';
                iconHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>';
                break;
            case 'error':
                bgColor = 'bg-red-100 text-red-700 dark:bg-red-800 dark:text-red-200';
                iconHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>';
                break;
            case 'info':
                bgColor = 'bg-blue-100 text-blue-700 dark:bg-blue-800 dark:text-blue-200';
                iconHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>';
                break;
        }

        toast.innerHTML = `
            <div class="${bgColor} flex items-center w-full rounded-lg p-4">
                ${iconHTML}
                <div class="ml-3 text-sm font-normal">${message}</div>
                <button type="button" class="ml-auto -mx-1.5 -my-1.5 rounded-lg p-1.5 inline-flex h-8 w-8 hover:bg-white/20" aria-label="Close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                </button>
            </div>
        `;

        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('translate-y-[-1rem]', 'opacity-0');
        }, 10);

        const closeButton = toast.querySelector('button');
        if (closeButton) {
            closeButton.addEventListener('click', () => {
                toast.classList.add('opacity-0', 'translate-y-[-1rem]');
                setTimeout(() => toast.remove(), 300);
            });
        }

        if (duration > 0) {
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-1rem]');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
    }

    // Fetch and render excused absences
    function loadExcusedAbsences(page = 1) {
        // Show loading state
        const tableLoading = document.getElementById('excused-table-loading');
        const tableNoResults = document.getElementById('excused-no-results');
        tableLoading.classList.remove('hidden');
        tableNoResults.classList.add('hidden');

        // Get filter values
        const searchQuery = document.getElementById('excused-search').value;
        const gradeFilter = document.getElementById('excused-grade-filter').value;
        const sectionFilter = document.getElementById('excused-section-filter').value;
        const statusFilter = document.getElementById('excused-status-filter').value;
        const dateFilter = document.getElementById('excused-date-filter').value;

        // Build API URL with query parameters
        let apiUrl = `/registrar/excused/search/?page=${page}`;
        if (searchQuery) apiUrl += `&search=${encodeURIComponent(searchQuery)}`;
        if (gradeFilter) apiUrl += `&grade=${gradeFilter}`;
        if (sectionFilter) apiUrl += `&section=${sectionFilter}`;
        if (statusFilter) apiUrl += `&status=${statusFilter}`;
        if (dateFilter) apiUrl += `&date=${dateFilter}`;

        fetch(apiUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderExcusedTable(data.records);
                // Show no results message if needed
                if (data.records.length === 0) {
                    tableNoResults.classList.remove('hidden');
                } else {
                    tableNoResults.classList.add('hidden');
                }
                // Update search results count
                const searchResultsCount = document.getElementById('excused-search-results-count');
                searchResultsCount.querySelector('span').textContent = `${data.total_count} records`;
                if (searchQuery) {
                    searchResultsCount.classList.remove('hidden');
                } else {
                    searchResultsCount.classList.add('hidden');
                }
            } else {
                showToast('Failed to load excused absences', 'error');
            }
        })
        .catch(error => {
            showToast('An error occurred while loading excused absences', 'error');
        })
        .finally(() => {
            tableLoading.classList.add('hidden');
        });
    }

    function renderExcusedTable(records) {
        const tbody = document.getElementById('excused-table-body');
        tbody.innerHTML = '';
        if (!records || records.length === 0) {
            tbody.innerHTML = `<tr><td colspan="11" class="text-center py-8 text-gray-500 dark:text-gray-400">No excused absences found.</td></tr>`;
            return;
        }
        records.forEach(record => {
            let statusBadge = '';
            switch (record.status) {
                case 'ACTIVE':
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Active</span>';
                    break;
                case 'UPCOMING':
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Upcoming</span>';
                    break;
                case 'EXPIRED':
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Expired</span>';
                    break;
                default:
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Unknown</span>';
            }
            // Always use default image for thumbnails to avoid 404 errors
            // PDFs can't be displayed as images anyway, so show default placeholder
            const thumbnailUrl = DEFAULT_EXCUSE_LETTER_IMG;
            const modalUrl = record.excuse_letter ? getExcuseLetterUrl(record.excuse_letter) : DEFAULT_EXCUSE_LETTER_IMG;
            const isDefault = !record.excuse_letter;
            const hasLetter = record.excuse_letter && record.excuse_letter !== 'default-excuse-letter.png';
            const excuseLetterCell = `
                <button class="view-excuse-letter-btn text-blue-600 underline hover:text-blue-800" 
                        data-url="${modalUrl}" 
                        data-filename="${record.excuse_letter ? record.excuse_letter : 'No Excuse Letter'}"
                        data-default="${isDefault}">
                    <img src="${thumbnailUrl}" 
                         alt="Excuse Letter" 
                         class="inline-block h-12 w-12 items-center object-cover rounded border border-gray-200 dark:border-gray-700 mr-2 ${hasLetter ? '' : 'opacity-50'}" 
                         style="background:#fff;">
                    ${hasLetter ? '<span class="text-xs text-green-600 dark:text-green-400">●</span>' : ''}
                </button>
            `;
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${record.lrn}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex-shrink-0 h-10 w-10">
                            ${record.profile_pic ?
                                `<img class="h-10 w-10 rounded-full object-cover border border-gray-200 dark:border-gray-700"
                                    src="${getProfilePicUrl(record.profile_pic)}"
                                    alt="Student Profile">`
                                :
                                `<div class="h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>`
                            }
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white">${record.full_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white">${record.grade}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white">${record.section}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white">${record.date_absent}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white">${record.effective_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white">${record.end_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-blue-600 dark:text-blue-400">${excuseLetterCell}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex justify-center space-x-2">
                            <button class="edit-excused-btn text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300" data-id="${record.id}" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button class="delete-excused-btn text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300" data-id="${record.id}" data-name="${record.full_name}" data-date="${record.date_absent}" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        // Add event listeners for "View" buttons
        document.querySelectorAll('.view-excuse-letter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const url = btn.getAttribute('data-url');
                const filename = btn.getAttribute('data-filename');
                showExcuseLetterModal(url, filename);
            });
        });

        // Add event listeners for edit buttons
        document.querySelectorAll('.edit-excused-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const excusedId = btn.getAttribute('data-id');
                openEditExcusedModal(excusedId);
            });
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-excused-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const excusedId = btn.getAttribute('data-id');
                const studentName = btn.getAttribute('data-name');
                const dateAbsent = btn.getAttribute('data-date');
                openDeleteExcusedModal(excusedId, studentName, dateAbsent);
            });
        });
    }



    // Filter and search event listeners
    document.getElementById('excused-search').addEventListener('input', debounce(filterExcused, 500));
    document.getElementById('excused-grade-filter').addEventListener('change', filterExcused);
    document.getElementById('excused-section-filter').addEventListener('change', filterExcused);
    document.getElementById('excused-status-filter').addEventListener('change', filterExcused);
    document.getElementById('excused-date-filter').addEventListener('change', filterExcused);

    // Export Dropdown Functionality
    const exportExcusedBtn = document.getElementById('export-excused-btn');
    const exportExcusedDropdown = document.getElementById('export-excused-dropdown');
    const exportExcusedOptions = document.querySelectorAll('.export-excused-option');

    if (exportExcusedBtn && exportExcusedDropdown) {
        // Toggle dropdown
        exportExcusedBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            exportExcusedDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!exportExcusedBtn.contains(e.target) && !exportExcusedDropdown.contains(e.target)) {
                exportExcusedDropdown.classList.add('hidden');
            }
        });

        // Handle export format selection
        exportExcusedOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const format = this.getAttribute('data-format');
                
                // Get current filter values
                const searchQuery = document.getElementById('excused-search')?.value || '';
                const gradeFilter = document.getElementById('excused-grade-filter')?.value || '';
                const sectionFilter = document.getElementById('excused-section-filter')?.value || '';
                const statusFilter = document.getElementById('excused-status-filter')?.value || '';
                const dateFilter = document.getElementById('excused-date-filter')?.value || '';
                
                // Build export URL with filters
                let exportUrl = `/registrar/excused/export/?format=${format}`;
                if (searchQuery) exportUrl += `&search=${encodeURIComponent(searchQuery)}`;
                if (gradeFilter) exportUrl += `&grade=${gradeFilter}`;
                if (sectionFilter) exportUrl += `&section=${sectionFilter}`;
                if (statusFilter) exportUrl += `&status=${statusFilter}`;
                if (dateFilter) exportUrl += `&date=${dateFilter}`;
                
                // Show loading toast
                showToast(`Preparing ${format.toUpperCase()} export...`, 'info', 2000);
                
                // Trigger download
                window.location.href = exportUrl;
                
                // Close dropdown
                exportExcusedDropdown.classList.add('hidden');
            });
        });
    }

    // Initial load
    loadExcusedAbsences(1);

    // Edit Excused Modal Functions
    const editExcusedModal = document.getElementById('edit-excused-modal');
    const editExcusedForm = document.getElementById('edit-excused-form');
    const cancelEditExcusedBtn = document.getElementById('cancel-edit-excused');
    const editExcusedBackdrop = document.getElementById('edit-excused-backdrop');

    async function openEditExcusedModal(excusedId) {
        console.log('[Edit Excused] Opening modal for ID:', excusedId);
        
        try {
            const response = await fetch(`/registrar/excused/${excusedId}/`);
            console.log('[Edit Excused] Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`Failed to fetch excused record: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('[Edit Excused] Full response data:', data);
            
            // Handle multiple response formats
            let record = null;
            
            // Check for different response structures
            if (data.status === 'success' && data.record) {
                record = data.record;
                console.log('[Edit Excused] Using data.record format');
            } else if (data.success && data.excused) {
                record = data.excused;
                console.log('[Edit Excused] Using data.excused format');
            } else if (data.id) {
                // Direct record format
                record = data;
                console.log('[Edit Excused] Using direct data format');
            }
            
            if (!record) {
                console.error('[Edit Excused] Could not find record in response');
                throw new Error('Invalid response format');
            }
            
            console.log('[Edit Excused] Extracted record:', record);
            
            // Populate form fields
            document.getElementById('edit-excused-id').value = record.id;
            
            // Student info
            const studentName = record.student_name || record.student?.full_name || 
                              `${record.student?.first_name || ''} ${record.student?.last_name || ''}`.trim();
            document.getElementById('edit-excused-student-name').textContent = studentName || 'N/A';
            document.getElementById('edit-excused-lrn').textContent = record.lrn || record.student?.lrn || 'N/A';
            
            const gradeSection = record.grade_section || 
                               `${record.grade?.name || ''} - ${record.section?.name || ''}`.trim();
            document.getElementById('edit-excused-grade-section').textContent = gradeSection || 'N/A';
            
            // Date fields
            document.getElementById('edit-excused-date-absent').value = record.date_absent || '';
            document.getElementById('edit-excused-effective-date').value = record.effective_date || '';
            document.getElementById('edit-excused-end-date').value = record.end_date || '';
            
            // Current excuse letter
            const excuseLetterSection = document.getElementById('current-excuse-letter-section');
            const excuseLetterLink = document.getElementById('current-excuse-letter-link');
            
            if (record.excuse_letter && record.excuse_letter !== 'default-excuse-letter.png') {
                // Check if file exists before showing link
                const fileUrl = getExcuseLetterUrl(record.excuse_letter);
                fetch(fileUrl, { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            excuseLetterSection.classList.remove('hidden');
                            excuseLetterLink.href = fileUrl;
                        } else {
                            excuseLetterSection.classList.add('hidden');
                        }
                    })
                    .catch(() => {
                        excuseLetterSection.classList.add('hidden');
                    });
            } else {
                excuseLetterSection.classList.add('hidden');
            }
            
            // Clear file input
            document.getElementById('edit-excused-letter').value = '';
            
            // Show modal
            editExcusedModal.classList.remove('hidden');
            console.log('[Edit Excused] Modal opened successfully');
            
        } catch (error) {
            console.error('[Edit Excused] Error:', error);
            showToast('Failed to load excused record', 'error');
        }
    }

    function closeEditExcusedModal() {
        editExcusedModal.classList.add('hidden');
    }

    // Edit form submission
    editExcusedForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const excusedId = document.getElementById('edit-excused-id').value;
        const formData = new FormData();
        
        formData.append('date_absent', document.getElementById('edit-excused-date-absent').value);
        formData.append('effective_date', document.getElementById('edit-excused-effective-date').value);
        formData.append('end_date', document.getElementById('edit-excused-end-date').value);
        
        // Add file if selected
        const fileInput = document.getElementById('edit-excused-letter');
        if (fileInput.files.length > 0) {
            formData.append('excuse_letter', fileInput.files[0]);
        }
        
        const submitBtn = document.getElementById('submit-edit-excused');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        
        try {
            const response = await fetch(`/registrar/excused/${excusedId}/update/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: formData
            });
            
            if (response.ok) {
                showToast('Excused absence updated successfully!', 'success');
                closeEditExcusedModal();
                location.reload();
            } else {
                const error = await response.json();
                showToast(error.message || 'Failed to update excused absence', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred while updating excused absence', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
        }
    });

    // Event listeners
    cancelEditExcusedBtn.addEventListener('click', closeEditExcusedModal);
    editExcusedBackdrop.addEventListener('click', closeEditExcusedModal);

    // Delete Excused Modal Function
    function openDeleteExcusedModal(excusedId, studentName, dateAbsent) {
        console.log('[Delete Excused] Opening delete modal for:', excusedId, studentName, dateAbsent);
        // TODO: Implement delete modal if needed
        if (confirm(`Are you sure you want to delete the excused absence for ${studentName} on ${dateAbsent}?`)) {
            deleteExcusedRecord(excusedId);
        }
    }

    async function deleteExcusedRecord(excusedId) {
        try {
            const response = await fetch(`/registrar/excused/${excusedId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (response.ok) {
                showToast('Excused absence deleted successfully!', 'success');
                location.reload();
            } else {
                const error = await response.json();
                showToast(error.message || 'Failed to delete excused absence', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred while deleting excused absence', 'error');
        }
    }

    // Make functions globally accessible for event listeners
    window.openEditExcusedModal = openEditExcusedModal;
    window.openDeleteExcusedModal = openDeleteExcusedModal;
});

function debounce(func, wait) {
    let timeout;
    return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}
function filterExcused() {
    // Show loading spinner in search box
    const searchSpinner = document.getElementById('excused-search-spinner');
    searchSpinner.classList.remove('hidden');
    loadExcusedAbsences(1);
    setTimeout(() => {
        searchSpinner.classList.add('hidden');
    }, 500);
}

// CRUD: Upload Excuse Letter
function uploadExcuseLetter(recordId, file, onSuccess, onError) {
    const formData = new FormData();
    formData.append('excuse_letter', file);
    formData.append('id', recordId);
    fetch(`/registrar/excused/upload_excuse_letter/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            onSuccess(data.filename);
        } else {
            onError(data.message || 'Upload failed');
        }
    })
    .catch(() => onError('Upload failed'));
}

// CRUD: Delete Excuse Letter
function deleteExcuseLetter(recordId, onSuccess, onError) {
    fetch(`/registrar/excused/delete_excuse_letter/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ id: recordId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            onSuccess();
        } else {
            onError(data.message || 'Delete failed');
        }
    })
    .catch(() => onError('Delete failed'));
}

// Add Excused Modal Functions
const addExcusedModal = document.getElementById('add-excused-modal');
const addExcusedForm = document.getElementById('add-excused-form');
const addExcusedBtn = document.getElementById('add-excused-btn');
const cancelAddExcusedBtn = document.getElementById('cancel-add-excused');
const addExcusedBackdrop = document.getElementById('add-excused-backdrop');

function openAddExcusedModal() {
    addExcusedForm.reset();
    addExcusedModal.classList.remove('hidden');
}

function closeAddExcusedModal() {
    addExcusedModal.classList.add('hidden');
}

// Grade change - load sections
document.getElementById('add-excused-grade').addEventListener('change', async function() {
    const gradeId = this.value;
    const sectionSelect = document.getElementById('add-excused-section');
    const studentSelect = document.getElementById('add-excused-student');
    
    sectionSelect.innerHTML = '<option value="">Loading...</option>';
    studentSelect.innerHTML = '<option value="">Select section first</option>';
    
    if (!gradeId) {
        sectionSelect.innerHTML = '<option value="">Select grade first</option>';
        return;
    }
    
    try {
        const response = await fetch(`/registrar/sections/by-grade/${gradeId}/`);
        const sections = await response.json();
        
        sectionSelect.innerHTML = '<option value="">Select Section</option>';
        sections.forEach(section => {
            sectionSelect.innerHTML += `<option value="${section.id}">${section.name}</option>`;
        });
    } catch (error) {
        console.error('Error loading sections:', error);
        sectionSelect.innerHTML = '<option value="">Error loading sections</option>';
    }
});

// Section change - load students
document.getElementById('add-excused-section').addEventListener('change', async function() {
    const sectionId = this.value;
    const studentSelect = document.getElementById('add-excused-student');
    
    studentSelect.innerHTML = '<option value="">Loading...</option>';
    
    if (!sectionId) {
        studentSelect.innerHTML = '<option value="">Select section first</option>';
        return;
    }
    
    try {
        const response = await fetch(`/registrar/students/by-section/${sectionId}/`);
        const students = await response.json();
        
        studentSelect.innerHTML = '<option value="">Select Student</option>';
        students.forEach(student => {
            studentSelect.innerHTML += `<option value="${student.id}">${student.last_name}, ${student.first_name} ${student.middle_name || ''}</option>`;
        });
    } catch (error) {
        console.error('Error loading students:', error);
        studentSelect.innerHTML = '<option value="">Error loading students</option>';
    }
});

// Form submission
addExcusedForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('student_id', document.getElementById('add-excused-student').value);
    formData.append('date_absent', document.getElementById('add-excused-date-absent').value);
    formData.append('effective_date', document.getElementById('add-excused-effective-date').value);
    formData.append('end_date', document.getElementById('add-excused-end-date').value);
    formData.append('reason', document.getElementById('add-excused-reason').value);
    
    const letterFile = document.getElementById('add-excused-letter').files[0];
    if (letterFile) {
        formData.append('excuse_letter', letterFile);
    }
    
    const submitBtn = document.getElementById('submit-add-excused');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';
    
    try {
        const response = await fetch('/registrar/excused/create/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        });
        
        if (response.ok) {
            showToast('Excused absence added successfully!', 'success');
            closeAddExcusedModal();
            location.reload(); // Reload to show new record
        } else {
            const error = await response.json();
            showToast(error.message || 'Failed to add excused absence', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('An error occurred while adding excused absence', 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Excused';
    }
});

// Event listeners
addExcusedBtn.addEventListener('click', openAddExcusedModal);
cancelAddExcusedBtn.addEventListener('click', closeAddExcusedModal);
addExcusedBackdrop.addEventListener('click', closeAddExcusedModal);

// Import Excused Modal Functions
function openImportExcusedModal() {
    const modal = document.getElementById('import-excused-modal');
    modal.classList.remove('hidden');
    setTimeout(() => {
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }
    }, 10);
    
    // Reset form
    document.getElementById('import-excused-form').reset();
    document.getElementById('import-excused-file-name').classList.add('hidden');
    document.getElementById('submit-import-excused').disabled = true;
    document.getElementById('import-excused-progress').classList.add('hidden');
    document.getElementById('import-excused-results').classList.add('hidden');
    document.getElementById('import-excused-results').innerHTML = '';
}

function closeImportExcusedModal() {
    const modal = document.getElementById('import-excused-modal');
    const modalContent = modal.querySelector('.modal-content');
    if (modalContent) {
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
    }
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

// Import button handler
const importExcusedBtn = document.getElementById('import-excused-btn');
if (importExcusedBtn) {
    importExcusedBtn.addEventListener('click', openImportExcusedModal);
}

// Also close when clicking on the backdrop (outside modal content)
const importExcusedModalOuter = document.getElementById('import-excused-modal');
if (importExcusedModalOuter) {
    importExcusedModalOuter.addEventListener('click', function(e) {
        if (e.target === importExcusedModalOuter) {
            closeImportExcusedModal();
        }
    });
}

// Handle file selection
document.getElementById('import-excused-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const fileNameDisplay = document.getElementById('import-excused-file-name');
    const submitBtn = document.getElementById('submit-import-excused');
    
    if (file) {
        // Validate file type
        const validTypes = [
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.ms-excel',
            'text/csv'
        ];
        
        if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
            showToast('Invalid file type. Please upload Excel (.xlsx, .xls) or CSV files only.', 'error');
            e.target.value = '';
            fileNameDisplay.classList.add('hidden');
            submitBtn.disabled = true;
            return;
        }
        
        // Validate file size (10MB max)
        if (file.size > 10 * 1024 * 1024) {
            showToast('File too large. Maximum file size is 10MB.', 'error');
            e.target.value = '';
            fileNameDisplay.classList.add('hidden');
            submitBtn.disabled = true;
            return;
        }
        
        fileNameDisplay.textContent = `Selected: ${file.name}`;
        fileNameDisplay.classList.remove('hidden');
        submitBtn.disabled = false;
    } else {
        fileNameDisplay.classList.add('hidden');
        submitBtn.disabled = true;
    }
});

// Modal close handlers
document.getElementById('close-import-excused-modal').addEventListener('click', closeImportExcusedModal);
document.getElementById('cancel-import-excused').addEventListener('click', closeImportExcusedModal);

// Submit import
document.getElementById('submit-import-excused').addEventListener('click', async function() {
    const fileInput = document.getElementById('import-excused-file');
    if (!fileInput.files[0]) {
        showToast('Please select a file', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    const progressDiv = document.getElementById('import-excused-progress');
    const progressBar = document.getElementById('import-excused-progress-bar');
    const progressPercent = document.getElementById('import-excused-progress-percent');
    const submitBtn = document.getElementById('submit-import-excused');
    
    progressDiv.classList.remove('hidden');
    submitBtn.disabled = true;

    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += 10;
            progressBar.style.width = progress + '%';
            progressPercent.textContent = progress + '%';
        }
    }, 100);

    try {
        const response = await fetch('/registrar/excused/import/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressPercent.textContent = '100%';

        const data = await response.json();
        const resultsDiv = document.getElementById('import-excused-results');
        
        setTimeout(() => {
            resultsDiv.classList.remove('hidden');
            
            if (data.status === 'success') {
                // Success with possible skipped records
                let successHTML = `
                    <div class="bg-green-900/20 border border-green-600/50 rounded-lg p-4">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-green-400 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <div class="flex-1">
                                <h5 class="font-semibold text-green-400 mb-2">${data.message || 'Import completed!'}</h5>
                `;
                
                if (data.created_count !== undefined || data.updated_count !== undefined || data.skipped_count !== undefined) {
                    successHTML += '<ul class="text-sm text-green-300 space-y-1">';
                    if (data.created_count > 0) successHTML += `<li>• Created: ${data.created_count} record(s)</li>`;
                    if (data.updated_count > 0) successHTML += `<li>• Updated: ${data.updated_count} record(s)</li>`;
                    if (data.skipped_count > 0) successHTML += `<li>• Skipped: ${data.skipped_count} record(s) (existing IDs or errors)</li>`;
                    successHTML += '</ul>';
                }
                
                successHTML += `
                            </div>
                        </div>
                    </div>
                `;
                
                // Show warning if there were errors
                if (data.errors && data.errors.length > 0) {
                    successHTML += `
                        <div class="bg-yellow-900/20 border border-yellow-600/50 rounded-lg p-4 mt-3">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-yellow-400 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <div class="flex-1">
                                    <h6 class="font-semibold text-yellow-400 mb-2">Errors:</h6>
                                    <ul class="text-sm text-yellow-300 space-y-1 max-h-40 overflow-y-auto">
                                        ${data.errors.slice(0, 10).map(err => `<li>• ${err}</li>`).join('')}
                                    </ul>
                                    ${data.errors.length > 10 ? `<p class="text-xs text-yellow-400 mt-2">... and ${data.errors.length - 10} more errors</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                resultsDiv.innerHTML = successHTML;
                showToast(data.message || 'Import completed successfully!', 'success');
                
                // Refresh the table and close modal
                loadExcusedAbsences(1);
                setTimeout(() => {
                    closeImportExcusedModal();
                }, 3000);
            } else {
                // Complete failure
                let errorHTML = `
                    <div class="bg-red-900/20 border border-red-600/50 rounded-lg p-4">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-red-400 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            <div class="flex-1">
                                <h5 class="font-semibold text-red-400 mb-2">Import Failed</h5>
                                <p class="text-sm text-red-300">${data.message || data.error || 'An error occurred during import'}</p>
                `;
                
                if (data.errors && data.errors.length > 0) {
                    errorHTML += `
                                <div class="mt-3 border-t border-red-600/30 pt-3">
                                    <h6 class="text-xs font-semibold text-red-400 mb-2">Errors:</h6>
                                    <ul class="text-xs text-red-300 space-y-1 max-h-40 overflow-y-auto">
                                        ${data.errors.slice(0, 10).map(err => `<li>• ${err}</li>`).join('')}
                                    </ul>
                                    ${data.errors.length > 10 ? `<p class="text-xs text-red-400 mt-2">... and ${data.errors.length - 10} more errors</p>` : ''}
                                </div>
                    `;
                }
                
                errorHTML += `
                            </div>
                        </div>
                    </div>
                `;
                
                resultsDiv.innerHTML = errorHTML;
                showToast(data.message || 'Import failed', 'error');
            }
        }, 500);
    } catch (error) {
        clearInterval(progressInterval);
        console.error('Error:', error);
        showToast('An error occurred during import. Please try again.', 'error');
    } finally {
        setTimeout(() => {
            submitBtn.disabled = false;
            progressDiv.classList.add('hidden');
        }, 1000);
    }
});
</script>
{% endblock %}
